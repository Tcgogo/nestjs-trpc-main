{"version":3,"file":"trpc.driver-C7vGo1xo.js","names":["app: any","TRPCDriver","moduleRef: ModuleRef","options: TRPCModuleOptions","appRouter: AnyRouter","HttpAdapterHost","ConsoleLogger"],"sources":["../lib/trpc.driver.ts"],"sourcesContent":["import { ConsoleLogger, Inject, Injectable, type Type } from '@nestjs/common';\nimport { HttpAdapterHost, ModuleRef } from '@nestjs/core';\nimport type { Application as ExpressApplication } from 'express';\nimport type { FastifyInstance as FastifyApplication } from 'fastify';\nimport type { TRPCContext, TRPCModuleOptions } from './interfaces';\nimport { type AnyRouter, initTRPC } from '@trpc/server';\nimport { TRPCFactory } from './factories/trpc.factory';\nimport { AppRouterHost } from './app-router.host';\nimport { ExpressDriver, FastifyDriver } from './drivers';\n\nfunction isExpressApplication(app: any): app is ExpressApplication {\n  return (\n    typeof app === 'function' &&\n    typeof app.get === 'function' &&\n    typeof app.post === 'function' &&\n    typeof app.use === 'function' &&\n    typeof app.listen === 'function'\n  );\n}\n\nfunction isFastifyApplication(app: any): app is FastifyApplication {\n  return (\n    typeof app === 'object' &&\n    app !== null &&\n    typeof app.get === 'function' &&\n    typeof app.post === 'function' &&\n    typeof app.register === 'function' &&\n    typeof app.listen === 'function'\n  );\n}\n\n@Injectable()\nexport class TRPCDriver<\n  TOptions extends Record<string, any> = TRPCModuleOptions,\n> {\n  @Inject(HttpAdapterHost)\n  protected readonly httpAdapterHost!: HttpAdapterHost;\n\n  @Inject(TRPCFactory)\n  protected readonly trpcFactory!: TRPCFactory;\n\n  @Inject(ConsoleLogger)\n  protected readonly consoleLogger!: ConsoleLogger;\n\n  @Inject(AppRouterHost)\n  protected readonly appRouterHost!: AppRouterHost;\n\n  @Inject(ExpressDriver)\n  protected readonly expressDriver!: ExpressDriver;\n\n  @Inject(FastifyDriver)\n  protected readonly fastifyDriver!: FastifyDriver;\n\n  constructor(private moduleRef: ModuleRef) {}\n\n  public async start(options: TRPCModuleOptions) {\n    const { procedure, router } = initTRPC.context().create({\n      ...(options.transformer != null\n        ? { transformer: options.transformer }\n        : {}),\n      ...(options.errorFormatter != null\n        ? { errorFormatter: options.errorFormatter }\n        : {}),\n    } as any);\n\n    const appRouter: AnyRouter = this.trpcFactory.serializeAppRoutes(\n      router,\n      procedure,\n    );\n\n    this.appRouterHost.appRouter = appRouter;\n\n    const contextClass = options.context;\n    const contextInstance =\n      contextClass != null\n        ? this.moduleRef.get<Type<TRPCContext>, TRPCContext>(contextClass, {\n            strict: false,\n          })\n        : null;\n\n    const { httpAdapter } = this.httpAdapterHost;\n    const platformName = httpAdapter.getType();\n\n    const app = httpAdapter.getInstance<\n      ExpressApplication | FastifyApplication\n    >();\n\n    if (platformName === 'express' && isExpressApplication(app)) {\n      await this.expressDriver.start(options, app, appRouter, contextInstance);\n    } else if (platformName === 'fastify' && isFastifyApplication(app)) {\n      await this.fastifyDriver.start(options, app, appRouter, contextInstance);\n    } else {\n      throw new Error(`Unsupported http adapter: ${platformName}`);\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAUA,SAAS,qBAAqBA,KAAqC;AACjE,eACS,QAAQ,qBACR,IAAI,QAAQ,qBACZ,IAAI,SAAS,qBACb,IAAI,QAAQ,qBACZ,IAAI,WAAW;AAEzB;AAED,SAAS,qBAAqBA,KAAqC;AACjE,eACS,QAAQ,YACf,QAAQ,eACD,IAAI,QAAQ,qBACZ,IAAI,SAAS,qBACb,IAAI,aAAa,qBACjB,IAAI,WAAW;AAEzB;AAGM,uBAAMC,aAEX;CAmBA,YAAoBC,WAAsB;EAAtB;2CAjBD;2CAGA;2CAGA;2CAGA;2CAGA;2CAGA;CAEyB;CAE5C,AAAa,MAAMC;2DAA4B;GAC7C,MAAM,EAAE,WAAW,QAAQ,GAAG,SAAS,SAAS,CAAC,+EAC3C,QAAQ,eAAe,OACvB,EAAE,aAAa,QAAQ,YAAa,IACpC,CAAE,IACF,QAAQ,kBAAkB,OAC1B,EAAE,gBAAgB,QAAQ,eAAgB,IAC1C,CAAE,GACC;GAET,MAAMC,YAAuB,KAAK,YAAY,mBAC5C,QACA,UACD;AAED,QAAK,cAAc,YAAY;GAE/B,MAAM,eAAe,QAAQ;GAC7B,MAAM,kBACJ,gBAAgB,OACZ,KAAK,UAAU,IAAoC,cAAc,EAC/D,QAAQ,MACT,EAAC,GACF;GAEN,MAAM,EAAE,aAAa,GAAG,KAAK;GAC7B,MAAM,eAAe,YAAY,SAAS;GAE1C,MAAM,MAAM,YAAY,aAErB;AAEH,OAAI,iBAAiB,aAAa,qBAAqB,IAAI,CACzD,OAAM,KAAK,cAAc,MAAM,SAAS,KAAK,WAAW,gBAAgB;YAC/D,iBAAiB,aAAa,qBAAqB,IAAI,CAChE,OAAM,KAAK,cAAc,MAAM,SAAS,KAAK,WAAW,gBAAgB;OAExE,OAAM,IAAI,MAAM,CAAC,0BAA0B,EAAE,cAAc;EAE9D;;AACF;8BA5DE,0BAAOC,4BAAgB;8BAGvB,0BAAO,YAAY;8BAGnB,0BAAOC,4BAAc;8BAGrB,0BAAO,cAAc;8BAGrB,0BAAO,cAAc;8BAGrB,0BAAO,cAAc;2CAnBvB,+BAAY"}