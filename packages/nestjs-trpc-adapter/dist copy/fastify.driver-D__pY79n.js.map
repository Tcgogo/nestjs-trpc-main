{"version":3,"file":"fastify.driver-D__pY79n.js","names":["import_objectSpread2","import_objectSpread2","FastifyDriver","options: TRPCModuleOptions","app: FastifyApplication","appRouter: AnyRouter","contextInstance: TRPCContext | null","opts: ContextOptions"],"sources":["../../../node_modules/.pnpm/@trpc+server@11.4.3_typescript@5.8.3/node_modules/@trpc/server/dist/ws-DsZkVWpZ.mjs","../../../node_modules/.pnpm/@trpc+server@11.4.3_typescript@5.8.3/node_modules/@trpc/server/dist/adapters/fastify/index.mjs","../lib/drivers/fastify.driver.ts"],"sourcesContent":["import { __toESM, getErrorShape, require_objectSpread2 } from \"./getErrorShape-Uhlrl4Bk.mjs\";\nimport { TRPCError, callProcedure, getTRPCErrorFromUnknown, isTrackedEnvelope, transformTRPCResponse } from \"./tracked-gU3ttYjg.mjs\";\nimport { isAsyncIterable, isObject, run } from \"./utils-DdbbrDku.mjs\";\nimport { parseTRPCMessage } from \"./parseTRPCMessage-ByIHyFRz.mjs\";\nimport { Unpromise, iteratorResource, parseConnectionParamsFromUnknown, require_usingCtx } from \"./resolveResponse-CzlbRpCI.mjs\";\nimport { isObservable, observableToAsyncIterable } from \"./observable-UMO3vUa_.mjs\";\nimport { createURL } from \"./node-http-ZvZKxPic.mjs\";\n\n//#region src/adapters/ws.ts\nvar import_objectSpread2 = __toESM(require_objectSpread2(), 1);\nvar import_usingCtx = __toESM(require_usingCtx(), 1);\n/**\n* Importing ws causes a build error\n* @see https://github.com/trpc/trpc/pull/5279\n*/\nconst WEBSOCKET_OPEN = 1;\nfunction getWSConnectionHandler(opts) {\n\tconst { createContext, router } = opts;\n\tconst { transformer } = router._def._config;\n\treturn (client, req) => {\n\t\tvar _opts$keepAlive;\n\t\tconst clientSubscriptions = /* @__PURE__ */ new Map();\n\t\tconst abortController = new AbortController();\n\t\tif ((_opts$keepAlive = opts.keepAlive) === null || _opts$keepAlive === void 0 ? void 0 : _opts$keepAlive.enabled) {\n\t\t\tconst { pingMs, pongWaitMs } = opts.keepAlive;\n\t\t\thandleKeepAlive(client, pingMs, pongWaitMs);\n\t\t}\n\t\tfunction respond(untransformedJSON) {\n\t\t\tclient.send(JSON.stringify(transformTRPCResponse(router._def._config, untransformedJSON)));\n\t\t}\n\t\tasync function createCtxPromise(getConnectionParams) {\n\t\t\ttry {\n\t\t\t\treturn await run(async () => {\n\t\t\t\t\tctx = await (createContext === null || createContext === void 0 ? void 0 : createContext({\n\t\t\t\t\t\treq,\n\t\t\t\t\t\tres: client,\n\t\t\t\t\t\tinfo: {\n\t\t\t\t\t\t\tconnectionParams: getConnectionParams(),\n\t\t\t\t\t\t\tcalls: [],\n\t\t\t\t\t\t\tisBatchCall: false,\n\t\t\t\t\t\t\taccept: null,\n\t\t\t\t\t\t\ttype: \"unknown\",\n\t\t\t\t\t\t\tsignal: abortController.signal,\n\t\t\t\t\t\t\turl: null\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t\treturn {\n\t\t\t\t\t\tok: true,\n\t\t\t\t\t\tvalue: ctx\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t} catch (cause) {\n\t\t\t\tvar _opts$onError, _globalThis$setImmedi;\n\t\t\t\tconst error = getTRPCErrorFromUnknown(cause);\n\t\t\t\t(_opts$onError = opts.onError) === null || _opts$onError === void 0 || _opts$onError.call(opts, {\n\t\t\t\t\terror,\n\t\t\t\t\tpath: void 0,\n\t\t\t\t\ttype: \"unknown\",\n\t\t\t\t\tctx,\n\t\t\t\t\treq,\n\t\t\t\t\tinput: void 0\n\t\t\t\t});\n\t\t\t\trespond({\n\t\t\t\t\tid: null,\n\t\t\t\t\terror: getErrorShape({\n\t\t\t\t\t\tconfig: router._def._config,\n\t\t\t\t\t\terror,\n\t\t\t\t\t\ttype: \"unknown\",\n\t\t\t\t\t\tpath: void 0,\n\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\tctx\n\t\t\t\t\t})\n\t\t\t\t});\n\t\t\t\t((_globalThis$setImmedi = globalThis.setImmediate) !== null && _globalThis$setImmedi !== void 0 ? _globalThis$setImmedi : globalThis.setTimeout)(() => {\n\t\t\t\t\tclient.close();\n\t\t\t\t});\n\t\t\t\treturn {\n\t\t\t\t\tok: false,\n\t\t\t\t\terror\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\tlet ctx = void 0;\n\t\t/**\n\t\t* promise for initializing the context\n\t\t*\n\t\t* - the context promise will be created immediately on connection if no connectionParams are expected\n\t\t* - if connection params are expected, they will be created once received\n\t\t*/\n\t\tlet ctxPromise = createURL(req).searchParams.get(\"connectionParams\") === \"1\" ? null : createCtxPromise(() => null);\n\t\tfunction handleRequest(msg) {\n\t\t\tconst { id, jsonrpc } = msg;\n\t\t\tif (id === null) {\n\t\t\t\tvar _opts$onError2;\n\t\t\t\tconst error = getTRPCErrorFromUnknown(new TRPCError({\n\t\t\t\t\tcode: \"PARSE_ERROR\",\n\t\t\t\t\tmessage: \"`id` is required\"\n\t\t\t\t}));\n\t\t\t\t(_opts$onError2 = opts.onError) === null || _opts$onError2 === void 0 || _opts$onError2.call(opts, {\n\t\t\t\t\terror,\n\t\t\t\t\tpath: void 0,\n\t\t\t\t\ttype: \"unknown\",\n\t\t\t\t\tctx,\n\t\t\t\t\treq,\n\t\t\t\t\tinput: void 0\n\t\t\t\t});\n\t\t\t\trespond({\n\t\t\t\t\tid,\n\t\t\t\t\tjsonrpc,\n\t\t\t\t\terror: getErrorShape({\n\t\t\t\t\t\tconfig: router._def._config,\n\t\t\t\t\t\terror,\n\t\t\t\t\t\ttype: \"unknown\",\n\t\t\t\t\t\tpath: void 0,\n\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\tctx\n\t\t\t\t\t})\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (msg.method === \"subscription.stop\") {\n\t\t\t\tvar _clientSubscriptions$;\n\t\t\t\t(_clientSubscriptions$ = clientSubscriptions.get(id)) === null || _clientSubscriptions$ === void 0 || _clientSubscriptions$.abort();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst { path, lastEventId } = msg.params;\n\t\t\tlet { input } = msg.params;\n\t\t\tconst type = msg.method;\n\t\t\tif (lastEventId !== void 0) if (isObject(input)) input = (0, import_objectSpread2.default)((0, import_objectSpread2.default)({}, input), {}, { lastEventId });\n\t\t\telse {\n\t\t\t\tvar _input;\n\t\t\t\t(_input = input) !== null && _input !== void 0 || (input = { lastEventId });\n\t\t\t}\n\t\t\trun(async () => {\n\t\t\t\tconst res = await ctxPromise;\n\t\t\t\tif (!res.ok) throw res.error;\n\t\t\t\tconst abortController$1 = new AbortController();\n\t\t\t\tconst result = await callProcedure({\n\t\t\t\t\trouter,\n\t\t\t\t\tpath,\n\t\t\t\t\tgetRawInput: async () => input,\n\t\t\t\t\tctx,\n\t\t\t\t\ttype,\n\t\t\t\t\tsignal: abortController$1.signal\n\t\t\t\t});\n\t\t\t\tconst isIterableResult = isAsyncIterable(result) || isObservable(result);\n\t\t\t\tif (type !== \"subscription\") {\n\t\t\t\t\tif (isIterableResult) throw new TRPCError({\n\t\t\t\t\t\tcode: \"UNSUPPORTED_MEDIA_TYPE\",\n\t\t\t\t\t\tmessage: `Cannot return an async iterable or observable from a ${type} procedure with WebSockets`\n\t\t\t\t\t});\n\t\t\t\t\trespond({\n\t\t\t\t\t\tid,\n\t\t\t\t\t\tjsonrpc,\n\t\t\t\t\t\tresult: {\n\t\t\t\t\t\t\ttype: \"data\",\n\t\t\t\t\t\t\tdata: result\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (!isIterableResult) throw new TRPCError({\n\t\t\t\t\tmessage: `Subscription ${path} did not return an observable or a AsyncGenerator`,\n\t\t\t\t\tcode: \"INTERNAL_SERVER_ERROR\"\n\t\t\t\t});\n\t\t\t\t/* istanbul ignore next -- @preserve */\n\t\t\t\tif (client.readyState !== WEBSOCKET_OPEN) return;\n\t\t\t\t/* istanbul ignore next -- @preserve */\n\t\t\t\tif (clientSubscriptions.has(id)) throw new TRPCError({\n\t\t\t\t\tmessage: `Duplicate id ${id}`,\n\t\t\t\t\tcode: \"BAD_REQUEST\"\n\t\t\t\t});\n\t\t\t\tconst iterable = isObservable(result) ? observableToAsyncIterable(result, abortController$1.signal) : result;\n\t\t\t\trun(async () => {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tvar _usingCtx = (0, import_usingCtx.default)();\n\t\t\t\t\t\tconst iterator = _usingCtx.a(iteratorResource(iterable));\n\t\t\t\t\t\tconst abortPromise = new Promise((resolve) => {\n\t\t\t\t\t\t\tabortController$1.signal.onabort = () => resolve(\"abort\");\n\t\t\t\t\t\t});\n\t\t\t\t\t\tlet next;\n\t\t\t\t\t\tlet result$1;\n\t\t\t\t\t\twhile (true) {\n\t\t\t\t\t\t\tnext = await Unpromise.race([iterator.next().catch(getTRPCErrorFromUnknown), abortPromise]);\n\t\t\t\t\t\t\tif (next === \"abort\") {\n\t\t\t\t\t\t\t\tvar _iterator$return;\n\t\t\t\t\t\t\t\tawait ((_iterator$return = iterator.return) === null || _iterator$return === void 0 ? void 0 : _iterator$return.call(iterator));\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (next instanceof Error) {\n\t\t\t\t\t\t\t\tvar _opts$onError3;\n\t\t\t\t\t\t\t\tconst error = getTRPCErrorFromUnknown(next);\n\t\t\t\t\t\t\t\t(_opts$onError3 = opts.onError) === null || _opts$onError3 === void 0 || _opts$onError3.call(opts, {\n\t\t\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t\t\t\tpath,\n\t\t\t\t\t\t\t\t\ttype,\n\t\t\t\t\t\t\t\t\tctx,\n\t\t\t\t\t\t\t\t\treq,\n\t\t\t\t\t\t\t\t\tinput\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\trespond({\n\t\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t\t\tjsonrpc,\n\t\t\t\t\t\t\t\t\terror: getErrorShape({\n\t\t\t\t\t\t\t\t\t\tconfig: router._def._config,\n\t\t\t\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t\t\t\t\ttype,\n\t\t\t\t\t\t\t\t\t\tpath,\n\t\t\t\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\t\t\t\tctx\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (next.done) break;\n\t\t\t\t\t\t\tresult$1 = {\n\t\t\t\t\t\t\t\ttype: \"data\",\n\t\t\t\t\t\t\t\tdata: next.value\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\tif (isTrackedEnvelope(next.value)) {\n\t\t\t\t\t\t\t\tconst [id$1, data] = next.value;\n\t\t\t\t\t\t\t\tresult$1.id = id$1;\n\t\t\t\t\t\t\t\tresult$1.data = {\n\t\t\t\t\t\t\t\t\tid: id$1,\n\t\t\t\t\t\t\t\t\tdata\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\trespond({\n\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t\tjsonrpc,\n\t\t\t\t\t\t\t\tresult: result$1\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tnext = null;\n\t\t\t\t\t\t\tresult$1 = null;\n\t\t\t\t\t\t}\n\t\t\t\t\t\trespond({\n\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\tjsonrpc,\n\t\t\t\t\t\t\tresult: { type: \"stopped\" }\n\t\t\t\t\t\t});\n\t\t\t\t\t\tclientSubscriptions.delete(id);\n\t\t\t\t\t} catch (_) {\n\t\t\t\t\t\t_usingCtx.e = _;\n\t\t\t\t\t} finally {\n\t\t\t\t\t\tawait _usingCtx.d();\n\t\t\t\t\t}\n\t\t\t\t}).catch((cause) => {\n\t\t\t\t\tvar _opts$onError4;\n\t\t\t\t\tconst error = getTRPCErrorFromUnknown(cause);\n\t\t\t\t\t(_opts$onError4 = opts.onError) === null || _opts$onError4 === void 0 || _opts$onError4.call(opts, {\n\t\t\t\t\t\terror,\n\t\t\t\t\t\tpath,\n\t\t\t\t\t\ttype,\n\t\t\t\t\t\tctx,\n\t\t\t\t\t\treq,\n\t\t\t\t\t\tinput\n\t\t\t\t\t});\n\t\t\t\t\trespond({\n\t\t\t\t\t\tid,\n\t\t\t\t\t\tjsonrpc,\n\t\t\t\t\t\terror: getErrorShape({\n\t\t\t\t\t\t\tconfig: router._def._config,\n\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t\ttype,\n\t\t\t\t\t\t\tpath,\n\t\t\t\t\t\t\tinput,\n\t\t\t\t\t\t\tctx\n\t\t\t\t\t\t})\n\t\t\t\t\t});\n\t\t\t\t\tabortController$1.abort();\n\t\t\t\t});\n\t\t\t\tclientSubscriptions.set(id, abortController$1);\n\t\t\t\trespond({\n\t\t\t\t\tid,\n\t\t\t\t\tjsonrpc,\n\t\t\t\t\tresult: { type: \"started\" }\n\t\t\t\t});\n\t\t\t}).catch((cause) => {\n\t\t\t\tvar _opts$onError5;\n\t\t\t\tconst error = getTRPCErrorFromUnknown(cause);\n\t\t\t\t(_opts$onError5 = opts.onError) === null || _opts$onError5 === void 0 || _opts$onError5.call(opts, {\n\t\t\t\t\terror,\n\t\t\t\t\tpath,\n\t\t\t\t\ttype,\n\t\t\t\t\tctx,\n\t\t\t\t\treq,\n\t\t\t\t\tinput\n\t\t\t\t});\n\t\t\t\trespond({\n\t\t\t\t\tid,\n\t\t\t\t\tjsonrpc,\n\t\t\t\t\terror: getErrorShape({\n\t\t\t\t\t\tconfig: router._def._config,\n\t\t\t\t\t\terror,\n\t\t\t\t\t\ttype,\n\t\t\t\t\t\tpath,\n\t\t\t\t\t\tinput,\n\t\t\t\t\t\tctx\n\t\t\t\t\t})\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t\tclient.on(\"message\", (rawData) => {\n\t\t\tconst msgStr = rawData.toString();\n\t\t\tif (msgStr === \"PONG\") return;\n\t\t\tif (msgStr === \"PING\") {\n\t\t\t\tif (!opts.dangerouslyDisablePong) client.send(\"PONG\");\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!ctxPromise) {\n\t\t\t\tctxPromise = createCtxPromise(() => {\n\t\t\t\t\tlet msg;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tmsg = JSON.parse(msgStr);\n\t\t\t\t\t\tif (!isObject(msg)) throw new Error(\"Message was not an object\");\n\t\t\t\t\t} catch (cause) {\n\t\t\t\t\t\tthrow new TRPCError({\n\t\t\t\t\t\t\tcode: \"PARSE_ERROR\",\n\t\t\t\t\t\t\tmessage: `Malformed TRPCConnectionParamsMessage`,\n\t\t\t\t\t\t\tcause\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\tconst connectionParams = parseConnectionParamsFromUnknown(msg.data);\n\t\t\t\t\treturn connectionParams;\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst parsedMsgs = run(() => {\n\t\t\t\ttry {\n\t\t\t\t\tconst msgJSON = JSON.parse(msgStr);\n\t\t\t\t\tconst msgs = Array.isArray(msgJSON) ? msgJSON : [msgJSON];\n\t\t\t\t\treturn msgs.map((raw) => parseTRPCMessage(raw, transformer));\n\t\t\t\t} catch (cause) {\n\t\t\t\t\tconst error = new TRPCError({\n\t\t\t\t\t\tcode: \"PARSE_ERROR\",\n\t\t\t\t\t\tcause\n\t\t\t\t\t});\n\t\t\t\t\trespond({\n\t\t\t\t\t\tid: null,\n\t\t\t\t\t\terror: getErrorShape({\n\t\t\t\t\t\t\tconfig: router._def._config,\n\t\t\t\t\t\t\terror,\n\t\t\t\t\t\t\ttype: \"unknown\",\n\t\t\t\t\t\t\tpath: void 0,\n\t\t\t\t\t\t\tinput: void 0,\n\t\t\t\t\t\t\tctx\n\t\t\t\t\t\t})\n\t\t\t\t\t});\n\t\t\t\t\treturn [];\n\t\t\t\t}\n\t\t\t});\n\t\t\tparsedMsgs.map(handleRequest);\n\t\t});\n\t\tclient.on(\"error\", (cause) => {\n\t\t\tvar _opts$onError6;\n\t\t\t(_opts$onError6 = opts.onError) === null || _opts$onError6 === void 0 || _opts$onError6.call(opts, {\n\t\t\t\tctx,\n\t\t\t\terror: getTRPCErrorFromUnknown(cause),\n\t\t\t\tinput: void 0,\n\t\t\t\tpath: void 0,\n\t\t\t\ttype: \"unknown\",\n\t\t\t\treq\n\t\t\t});\n\t\t});\n\t\tclient.once(\"close\", () => {\n\t\t\tfor (const sub of clientSubscriptions.values()) sub.abort();\n\t\t\tclientSubscriptions.clear();\n\t\t\tabortController.abort();\n\t\t});\n\t};\n}\n/**\n* Handle WebSocket keep-alive messages\n*/\nfunction handleKeepAlive(client, pingMs = 3e4, pongWaitMs = 5e3) {\n\tlet timeout = void 0;\n\tlet ping = void 0;\n\tconst schedulePing = () => {\n\t\tconst scheduleTimeout = () => {\n\t\t\ttimeout = setTimeout(() => {\n\t\t\t\tclient.terminate();\n\t\t\t}, pongWaitMs);\n\t\t};\n\t\tping = setTimeout(() => {\n\t\t\tclient.send(\"PING\");\n\t\t\tscheduleTimeout();\n\t\t}, pingMs);\n\t};\n\tconst onMessage = () => {\n\t\tclearTimeout(ping);\n\t\tclearTimeout(timeout);\n\t\tschedulePing();\n\t};\n\tclient.on(\"message\", onMessage);\n\tclient.on(\"close\", () => {\n\t\tclearTimeout(ping);\n\t\tclearTimeout(timeout);\n\t});\n\tschedulePing();\n}\nfunction applyWSSHandler(opts) {\n\tconst onConnection = getWSConnectionHandler(opts);\n\topts.wss.on(\"connection\", (client, req) => {\n\t\tvar _req$url;\n\t\tif (opts.prefix && !((_req$url = req.url) === null || _req$url === void 0 ? void 0 : _req$url.startsWith(opts.prefix))) return;\n\t\tonConnection(client, req);\n\t});\n\treturn { broadcastReconnectNotification: () => {\n\t\tconst response = {\n\t\t\tid: null,\n\t\t\tmethod: \"reconnect\"\n\t\t};\n\t\tconst data = JSON.stringify(response);\n\t\tfor (const client of opts.wss.clients) if (client.readyState === WEBSOCKET_OPEN) client.send(data);\n\t} };\n}\n\n//#endregion\nexport { applyWSSHandler, getWSConnectionHandler, handleKeepAlive };\n//# sourceMappingURL=ws-DsZkVWpZ.mjs.map","import { __toESM, require_objectSpread2 } from \"../../getErrorShape-Uhlrl4Bk.mjs\";\nimport \"../../tracked-gU3ttYjg.mjs\";\nimport \"../../utils-DdbbrDku.mjs\";\nimport \"../../parseTRPCMessage-ByIHyFRz.mjs\";\nimport { resolveResponse } from \"../../resolveResponse-CzlbRpCI.mjs\";\nimport \"../../contentTypeParsers-SN4WL9ze.mjs\";\nimport \"../../unstable-core-do-not-import-D89CaGtL.mjs\";\nimport \"../../observable-UMO3vUa_.mjs\";\nimport \"../../initTRPC-IT_6ZYJd.mjs\";\nimport \"../../http-CWyjOa1l.mjs\";\nimport { incomingMessageToRequest } from \"../../node-http-ZvZKxPic.mjs\";\nimport \"../../observable-CUiPknO-.mjs\";\nimport { getWSConnectionHandler, handleKeepAlive } from \"../../ws-DsZkVWpZ.mjs\";\n\n//#region src/adapters/fastify/fastifyRequestHandler.ts\nvar import_objectSpread2$1 = __toESM(require_objectSpread2(), 1);\nasync function fastifyRequestHandler(opts) {\n\tconst createContext = async (innerOpts) => {\n\t\tvar _opts$createContext;\n\t\treturn await ((_opts$createContext = opts.createContext) === null || _opts$createContext === void 0 ? void 0 : _opts$createContext.call(opts, (0, import_objectSpread2$1.default)((0, import_objectSpread2$1.default)({}, opts), innerOpts)));\n\t};\n\tconst incomingMessage = opts.req.raw;\n\tif (\"body\" in opts.req) incomingMessage.body = opts.req.body;\n\tconst req = incomingMessageToRequest(incomingMessage, opts.res.raw, { maxBodySize: null });\n\tconst res = await resolveResponse((0, import_objectSpread2$1.default)((0, import_objectSpread2$1.default)({}, opts), {}, {\n\t\treq,\n\t\terror: null,\n\t\tcreateContext,\n\t\tonError(o) {\n\t\t\tvar _opts$onError;\n\t\t\topts === null || opts === void 0 || (_opts$onError = opts.onError) === null || _opts$onError === void 0 || _opts$onError.call(opts, (0, import_objectSpread2$1.default)((0, import_objectSpread2$1.default)({}, o), {}, { req: opts.req }));\n\t\t}\n\t}));\n\tawait opts.res.send(res);\n}\n\n//#endregion\n//#region src/adapters/fastify/fastifyTRPCPlugin.ts\nvar import_objectSpread2 = __toESM(require_objectSpread2(), 1);\nfunction fastifyTRPCPlugin(fastify, opts, done) {\n\tvar _opts$prefix;\n\tfastify.removeContentTypeParser(\"application/json\");\n\tfastify.addContentTypeParser(\"application/json\", { parseAs: \"string\" }, function(_, body, _done) {\n\t\t_done(null, body);\n\t});\n\tlet prefix = (_opts$prefix = opts.prefix) !== null && _opts$prefix !== void 0 ? _opts$prefix : \"\";\n\tif (typeof fastifyTRPCPlugin.default !== \"function\") prefix = \"\";\n\tfastify.all(`${prefix}/:path`, async (req, res) => {\n\t\tconst path = req.params.path;\n\t\tawait fastifyRequestHandler((0, import_objectSpread2.default)((0, import_objectSpread2.default)({}, opts.trpcOptions), {}, {\n\t\t\treq,\n\t\t\tres,\n\t\t\tpath\n\t\t}));\n\t});\n\tif (opts.useWSS) {\n\t\tvar _prefix;\n\t\tconst trpcOptions = opts.trpcOptions;\n\t\tconst onConnection = getWSConnectionHandler((0, import_objectSpread2.default)({}, trpcOptions));\n\t\tfastify.get((_prefix = prefix) !== null && _prefix !== void 0 ? _prefix : \"/\", { websocket: true }, (socket, req) => {\n\t\t\tvar _trpcOptions$keepAliv;\n\t\t\tonConnection(socket, req.raw);\n\t\t\tif (trpcOptions === null || trpcOptions === void 0 || (_trpcOptions$keepAliv = trpcOptions.keepAlive) === null || _trpcOptions$keepAliv === void 0 ? void 0 : _trpcOptions$keepAliv.enabled) {\n\t\t\t\tconst { pingMs, pongWaitMs } = trpcOptions.keepAlive;\n\t\t\t\thandleKeepAlive(socket, pingMs, pongWaitMs);\n\t\t\t}\n\t\t});\n\t}\n\tdone();\n}\n\n//#endregion\nexport { fastifyRequestHandler, fastifyTRPCPlugin };\n//# sourceMappingURL=index.mjs.map","import { Injectable } from \"@nestjs/common\";\nimport type { FastifyInstance as FastifyApplication } from \"fastify\";\nimport type {\n  ContextOptions,\n  TRPCContext,\n  TRPCModuleOptions,\n} from \"../interfaces\";\nimport type { AnyRouter } from \"@trpc/server\";\nimport * as trpcFastify from \"@trpc/server/adapters/fastify\";\n\n@Injectable()\nexport class FastifyDriver<\n  TOptions extends Record<string, any> = TRPCModuleOptions,\n> {\n  public async start(\n    options: TRPCModuleOptions,\n    app: FastifyApplication,\n    appRouter: AnyRouter,\n    contextInstance: TRPCContext | null,\n  ) {\n    app.register(trpcFastify.fastifyTRPCPlugin as any, {\n      prefix: options.basePath ?? \"/trpc\",\n      trpcOptions: {\n        router: appRouter,\n        ...(options.context != null && contextInstance != null\n          ? {\n              createContext: (opts: ContextOptions) =>\n                contextInstance.create(opts),\n            }\n          : {}),\n      },\n    });\n  }\n}\n"],"x_google_ignoreList":[0,1],"mappings":"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"}